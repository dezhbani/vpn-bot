name: Advanced Deploy Workflow Without Root

on:
  push:
    branches:
      - frontend-production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Check out the repository
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. Setup SSH
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p 9011 -H 87.248.150.99 >> ~/.ssh/known_hosts

    # 3. Install Node.js and npm using nvm
    - name: Install Node.js and npm
      run: |
        ssh -p 9011 -o StrictHostKeyChecking=no app@87.248.150.99 << 'EOF'
        # Install NVM if not already installed
        if [ ! -d "$HOME/.nvm" ]; then
          echo "NVM not found. Installing..."
          curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash
        else
          echo "NVM already installed."
        fi

        # Load NVM and install Node.js
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" # This loads nvm
        [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion" # This loads nvm bash_completion

        # Install specific version of Node.js
        nvm install 20.11.1
        nvm use 20.11.1

        # Check installed versions
        echo "Node.js version: $(node -v)"
        echo "npm version: $(npm -v)"
        EOF
